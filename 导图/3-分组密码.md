# 应用密码学

## 第三章：分组密码

将明文转换为数字序列后，分为长为n的组，各组分别在密钥控制下变换为等长的输出数字序列。
密钥控制算法

Vn * K ---> Vm

K是固定的，密钥定长

增大映射，使明文和密文之间的映射增大，在密钥控制下，找到一个足够大足够好的置换子集，对当前的明文数字组加密变换

### 基本概念

- 分组密码用于构造：

	- 流密码
	- 消息认证
	- 伪随机数生成器
	- 签字、实体认证等

- 代换

  每个分组密码对应唯一的密文分组，可逆变换

	- 可逆变换个数2^n !

	  n要足够大，明文统计特性才可以被隐藏

- 扩散

  将明文统计特性散布到密文中。
  通过变换后，由多个明文产生一个密文。
  每个字母出现的频率更接近一致
  
  明文和密文间的统计规律更复杂

- 混淆

  密文和密钥间的关联性降低
  
  利用复杂的代换算法达到混淆

### DES设计思想

Data Encryption Standard

- DES

  最广泛使用的，分组长度64比特，56比特密钥长度

	- 明文初始置换IP

	  64比特明文数据重排

	- 16轮变换

	  16轮数据的代换、置换运算。
	  第十六轮时，输出数据左右分组交换
	  56比特密钥，置换选择1，然后左循环移位，置换选择2生成密钥K，与刚初始置换完的明文进行第一轮变换。
	  （见PPT3_2DES设计 第五页流程图）

	- 逆初始置换IP

	  产生64比特密文

- Feistel密码结构

  乘积密码：顺序执行两个或多个密码系统，比单个密码强度高
  
  结构也是代换、置换（DES的第二步）
  
  除了初始置换和逆置换，和DES基本一样

	- 明文分为左右两半，迭代后再合并产生密文

	  代换和置换
	  
	  代换：每轮中右半数据被作用于轮函数后，再与左边异或。
	  置换：左右两边分组数据交换

	- 加密

	  每轮子密钥各不相同，所以K不同
	  
	  i轮迭代的输入是前轮输出的函数
	  
	  右边作为轮函数，再与左边异或
	  
	  Li=Ri-1
	  Ri = Li-1异或F（Ri-1，Ki）

	- 解密

	  使用子密钥顺序与加密相反，可以保证加解密采用同一算法。
	  加密自上而下，解密自下而上
	  
	  Ri-1 = Li
	  Li-1  = Ri 异或 （Ri-1，Ki）
	          =Ri 异或 （Li，Ki）

- Feistel网络实现特性

	- 分组大小

	  分组越大越安全，加密也越慢

	- 密钥大小

	  密钥越长越安全，加密越慢

	- 轮数

	  单轮不安全，多轮够安全

	- 子密钥产生算法

	  复杂度越高越安全，密码分析越困难

	- 轮函数

	  复杂性越大，密码分析困难性越大

### DES轮函数及算法安全性

- DES轮函数

  明文64比特分为两组L、R（类似feistel网络）

	- 64bite明文处理

		- 左半部分32比特

		  Li=Ri-1

		- 右半部分32比特

		  Ri = Li-1异或F（Ri-1，Ki）
		  
		  F实现的内容：R组32比特--->扩展成48比特（E表）--->与48比特的密钥异或---->代换（S盒）变为32比特--->置换（P）--->32比特输出

			- S盒

			  F中的代换由8个S盒组成，
			  每个S盒输入长为6比特，输出为4比特
			  
			  S盒的每一行定义代换的可逆（映射唯一）
			  
			  首尾形成一个二进制数，选行（纵列里找到数字）
			  中间的二进制数，形成一个十进制，选列（在行里挑到对应的数）
			  交汇处的十进制数，转换为一个二进制，输出

	- 56bite有效密钥生成

	  流程图3_3 P12

		- 置换运算

		  64位密钥，去掉八位校验位，并改变顺序

		- 分为左右各28比特

		  将置换后的56比特，分为左右各28比特，C0 D0

		- 左循环移位，输入到置换选择2

		  第i轮C i-1 和D i-1分别左循环移位，得到Ci和Di，作为下一轮子密钥的输入。同时输入到置换选择2

		- 产生48比特Ki，输入函数F

		  置换选择2，生成48比特Ki，为本轮子密钥，输入函数F（Ri-1，Ki）

	- DES解密

	  和feistel解密同理
	  加密解密使用统一算法，子密钥使用顺序相反

- 双重及三重DES

  增加密钥长度，多加密几次

	- 双重DES

		- 两个加密密钥

		  解密时，顺序相反使用

		- 密钥长度112

		  若能找到K3，使得K1加密P后再用K2加密，得到的结果等于K3加密P，则它的效果相当于单重DES加密

		- 中途相遇攻击

		  DES加密，64比特分组映射到一个分组，
		  有2^64个可能输入分组。
		  总映射数为2^64！
		  
		  穷举，由于DES对称性，以及计算数量级（2^64）不大，所以找到正确密钥的概率较大
		  
		  步骤：
		  1.C=EK2 [ EK1[P] ]
		  用2^56个可能的K1对P进行加密，EK1[P]，将结果保存到X
		  
		  2.用2^56个可能的K2对C，进行解密（相当于得到EK1[P]），把得到的结果与X进行匹配查找。 
		  
		  3.把匹配项的K1、K2记录下来
		  
		  4.再用一个新的（P‘，C'）检验K1，K2（对P‘两次加密，看得到的是不是C’）

			- 属于密钥穷举搜索

			  已知两个明文密文对，找到正确密钥

			- 已知一对明文密文攻击方式：

				- 用K1加密P，结果存到X

				  C=EK2 [ EK1[P] ]
				  用2^56个可能的K1对P进行加密，EK1[P]，将结果保存到X

				- 用K2解密C，把结果与X匹配查找

				  用2^56个可能的K2对C，进行解密（相当于得到EK1[P]），把得到的结果与X进行匹配查找。

				- 记录下结果匹配的那组K1、K2

				  把匹配项的K1、K2记录下来

				- 用一组新的（P'，C'），检验K1、K2

				  .再用一个新的（P‘，C'）检验K1，K2（对P‘两次加密，看得到的是不是C’）

	- 三重DES

	  避免中途相遇攻击

		- 两个密钥三次加密

		  加密--解密--加密

			- C=Ek1 [DK2 [Ek1[P]] ]

			  第二步解密目的：使得用户可对一重DES加密的数据解密

			- 用于密钥管理标准

				- ANS X.917
				- ISO 8732

		- 三个密钥三次加密

			- 明文攻击代价2^112
			- 密钥长度168
			- C=Ek3【Dk2 [Ek1[P] ] 】
			- 在PGP、S/MIME中被采用

- 差分密码分析

	- 攻击迭代密码最有效的方法之一
	- 分析明文对的差值如何影响密文对的差值，来恢复某些密钥比特

- 线性密码分析

	- 对迭代密码的一种已知明文攻击
	- 利用密码算法中的“不平衡的线性逼近”
	- 对不同明文密文重复有效的线性逼近，可得关于密钥的一组线性方程，从而确定出密钥比特

### 分组密码运行模式

- 电码本模式ECB

  Electronic Codebook

	- 一次对64比特长的明文分组加密
	- 每次加/解密密钥相同
	- 长于64比特的，分成64比特一组。不足的补全
	- 最适用于传递DES密钥（短数据的传输）
	- 不能隐藏消息特征

- 密码分组链接模式CBC

  Cipher Block Chaining

	- 可以让重复的明文产生不同的密文分组（隐藏消息特征）
	- 可用于长数据加密
	- 成链，加密算法每次之间有关联

	  一次对一个明文分组加密，使用同一密钥。
	  加密算法的输入，本次明文分组与上一次密文分组的异或

		- 第一组密文：初始向量IV与第一个明文分组异或

		  解密时，每一个密文分组被解密后，与前一个密文分组异或
		  
		  IV和解密算法对第一个密文分组的输出异或，恢复第一个明文

		- IV双方已知，且像密钥一样保存
		- 明文分组比特依赖于IV的比特

		  IV一变，结果都变

- 密码反馈模式CFB

  Cipher Feedback
  比较费时

	- 将64比特的DES转换为流密码
	- 实时运行，不需要填充
	- 流密码明文、密文等长。密钥等长
	- 能提供数据流的认证
	- 不抗干扰

	  明文单元被链接在一起，与CBC一样，使得密文是前面所有明文的函数
	  
	  移位寄存器的输入，一比特错误会影响解密结果中各明文单元的值

	- 将加密算法输出与明文异或生成的密文单元反馈到移位寄存器

	  DES变为密钥流Ki，再与明文异或产生密文

	- 加密/解密

		- 输入：64比特移位寄存器，初始向量IV
		- 输出：加密算法最高有效位（最左）j比特与明文的第一个单元异或，产生出密文C1
		- 将移位寄存器的内容左移j位（丢弃），并将C1送到最右j位，直到所有都被加密
		- 解密：密文单元与加密函数的输出异或

- 输出反馈模式OFB

  Output feedback

	- 将加密算法输出反馈到移位寄存器
	- 适用于有干扰的信道传输数据流

	  传输过程中的比特错误不会被传播

	- 易受到消息流的篡改攻击

	  可通过对消息校验部分的篡改和对数据部分的篡改，而以纠错码不能检测的方式篡改密文。需要额外认证

	- 不接触明文

### 有限域

- 基本概念

	- 加法

		- 满足交换律、结合律
		- 有零元、有负元

	- 乘法

		- 满足交换律、结合率，对加法满足分配律
		- 有单位元、有逆元（需满足条件）

		  整数a在模n乘法下有逆元，当且仅当a与n互素

- 多项式表示

	- AES按字节处理数据

	  一个字节8位 两组二进制表示

	- 二进制表示多项式

	  十六进制数‘57’（5和7）对应二进制为0101  0111（不足四位在前面补0）
	  看成一个字节，对应的多项式 
	  x^6 + x^4 + x^2 + x +1
	  （次数n-1）

	- 域加法

	  系数异或相加（模2无进位）
	  每个元素的加法逆元等于自己
	  
	  ‘57’ + ‘83’ = ‘D4’
	  (X^6 + X^4 + X^2 + X +1)+ (X^7 + X +1)=
	  X^7 + X^6 + X^4 +X^2
	    
	  x+1 与 X+1 相同的，异或后为0，不要了

	- 域乘法

		- 8次不可约多项式

		  m（x）=x^8 + x^4 + x^3 + x +1
		  11B

		- 是否为有限域，需要乘法的定义保证逆元存在
		- xtime

		  见ppt3.5

			- b7=1

			  左移一位，最后补零，再与1B（0001 1011）进行逐比特异或

			- b7=0

			  把字节b左移一位，在最右补0

## Rijndael算法

### 格式

- 密钥长度

  128、160、192、224、256 bite

- 明文分组长度

  128、160、192、224、256 比特

### 轮函数

不同层特定选择大部分建立在“宽轨迹策略” ------> 抗线性密码分析和差分密码分析能力

- 三层

  三个不同可逆均匀变换的层
  均匀变换：状态的每个比特都是用类似方法进行处理的

	- 线性混合层

	  确保多轮之上的高度扩散

	- 非线性层

	  S盒

	- 密钥加层

	  单轮子密钥简单地异或到中间状态上，实现一次性掩盖

- 结构

	- 字节代换
	- 行移位
	- 列混合
	- 轮密钥加

	  迭代轮数随密钥长度和分组长度的不同而变化，最低10轮，最高十四轮

### 密钥扩展

- 根据种子密钥生成轮密钥的过程

  种子密钥，以字节为元素矩阵阵列表示。有四行，列数记为Nk，Nk的长度是分组长度除以32

- 对应128、192、256 比特密钥生成11、13、15组 128位轮密钥

### S盒设计

- 有限域GF（2^8）上非线性替换
- Rijndael算法中唯一的非线性部件

### 加解密

加密算法与解密算法的计算网络相同，只是将各计算部分换为对应的逆部件

## AES标准

### 特点

- aes公开
- 对称密钥分组密码体制
- 密钥长度可变

  可独立指定为128、192、256比特

- 明文分组128比特
- 安全性高

  抗差分攻击和线性分析

### 算法框架

- 状态

  算法中间结果的分组为状态，所有操作在上面进行
  
  中间结果分组，以字节为元素的矩阵阵列。分为四行，有Nb列，Nb的长度等于分组长度除以32

- 种子密钥

  种子密钥，以字节为元素矩阵阵列表示。有四行，列数记为Nk，Nk的长度是分组长度除以32

*XMind: ZEN - Trial Version*